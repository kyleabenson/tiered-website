<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.54">


<title data-react-helmet="true">Google Cloud Platform | Ansible for N-Tier Webapp Deployments</title>

<meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Google Cloud Platform | Ansible for N-Tier Webapp Deployments"><meta data-react-helmet="true" name="description" content="Google Cloud Platform has a comprehensive and certified Ansible collection that provides a good deal of ease and flexibility in getting started with our deployment. "><meta data-react-helmet="true" property="og:description" content="Google Cloud Platform has a comprehensive and certified Ansible collection that provides a good deal of ease and flexibility in getting started with our deployment. "><meta data-react-helmet="true" property="og:url" content="https://kyleabenson.github.io/tiered-website/tiered-website/docs/gcp">

<link data-react-helmet="true" rel="shortcut icon" href="/tiered-website/img/favicon.ico">


<link rel="stylesheet" href="/tiered-website/styles.273885d5.css">


<link rel="preload" href="/tiered-website/styles.77a41af3.js" as="script">

<link rel="preload" href="/tiered-website/runtime~main.88a59206.js" as="script">

<link rel="preload" href="/tiered-website/main.b46ab0b8.js" as="script">

<link rel="preload" href="/tiered-website/1.ec644f8d.js" as="script">

<link rel="preload" href="/tiered-website/2.4c4c9348.js" as="script">

<link rel="preload" href="/tiered-website/20.4f78e627.js" as="script">

<link rel="preload" href="/tiered-website/39b4e302.6884ff92.js" as="script">

<link rel="preload" href="/tiered-website/17896441.4c0ae586.js" as="script">

<link rel="preload" href="/tiered-website/1800c3e5.88b1af97.js" as="script">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/tiered-website/"><img class="navbar__logo" src="/tiered-website/img/redhat.png" alt="My Site Logo"><strong class="navbar__title">My Site</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/tiered-website/docs/overview">Docs</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/tiered-website/"><img class="navbar__logo" src="/tiered-website/img/redhat.png" alt="My Site Logo"><strong class="navbar__title">My Site</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" position="left" href="/tiered-website/docs/overview">Docs</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp"><div class="sidebar_1kLs"><div class="menu menu--responsive menu_w2sC"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Components</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tiered-website/docs/overview">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tiered-website/docs/presentation">Presentation Layer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tiered-website/docs/bizlogic">Business Logic Layer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tiered-website/docs/db">Database Layer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tiered-website/docs/lb">Load Balancer</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Supported Clouds</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tiered-website/docs/aws">Amazon Web Services</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tiered-website/docs/azure">Azure</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" tabindex="0" href="/tiered-website/docs/gcp">Google Cloud Platform</a></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div class="container padding-vert--lg docItemWrapper_1cc7"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">Google Cloud Platform</h1></header><div class="markdown"><p>Google Cloud Platform has a comprehensive and certified Ansible collection that provides a good deal of ease and flexibility in getting started with our deployment. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="prerequisites"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#prerequisites" title="Direct link to heading">#</a>Prerequisites</h2><p>This guide walks through some complex steps and assumes some existing knowledge of using Ansible. That being said I have done my best to make this easy to operate. If you complete the work inside the prerequisite section, you should be able to execute this playbook without issue.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="a-note-about-collections"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#a-note-about-collections" title="Direct link to heading">#</a>A note about collections</h3><p>We&#x27;ll be using the Google Cloud Collection for this exercise, which means you&#x27;ll need to be running at least Ansible version 2.9 in order to proceed. To confirm your version, run:<br>
<code>ansible --version</code>  </p><p>Then you&#x27;ll want to install the collection:<br>
<code>ansible-galaxy collection install google.cloud</code></p><p>The syntax for calling a collection looks slightly different. While there are options to make this less apparent I am using the full syntax to highlight that we&#x27;re using a collection, and you&#x27;ll notice that calling modules and roles looks slightly different:<br>
<code>google.cloud.gcp_compute_instance</code><br>
Where the normal module would look like:<br>
<code>gcp_compute_instance</code>  </p><p>Before interacting with Google Cloud Platform, you&#x27;ll need to install some dependencies for the GCP colletion. Specifically the <code>requests</code> and <code>google-auth</code> packages:<br>
<code>pip install requests google-auth</code>  </p><p>You&#x27;ll also need to configure your credentials. In this tutorial we&#x27;ll be using the <code>serviceaccount</code> type credential, so be sure to checkout the <a href="https://docs.ansible.com/ansible/latest/scenario_guides/guide_gce.html">GCP Getting Started Guide</a> if you&#x27;re not familiar with that process. </p><p>Before proceeding, you should have a project created, as well as a serviceaccount with it&#x27;s corresponding credential file. </p><p>Make sure to populate the file <code>config.yml</code> with the appropriate contents for GCP. Note that the first several values will be dependent on your project name, credential file, and regional specifications. The ones below as listed solely as an example:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">gcp_project: kbenson-workspace</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">gcp_cred_kind: serviceaccount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">gcp_cred_file: kbenson-workspace.json</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">gcp_region: us-east1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">gcp_zone: &quot;{{ gcp_region }}-b&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">gcp_instance_group_name: simple-frontend</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">gcp_lb_name_prefix: frontend</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">gcp_source_image: &quot;projects/rhel-cloud/global/images/rhel-8-v20200413&quot;</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="presentation"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#presentation" title="Direct link to heading">#</a>Presentation</h2><p>For the presentation layer, we&#x27;ll be creating a set of autoscale VMs to automatically scale up and down based on a health check metric. For the purposes of this tutorial we&#x27;ll be using CPU load on the systems. We can achieve this with 3 tasks:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">   - name: Create A Instance Template</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      google.cloud.gcp_compute_instance_template:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        name: simple-frontend</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        properties:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            machine_type: f1-micro</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            disks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            - auto_delete: &#x27;true&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              boot: &#x27;true&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              device_name: device1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              initialize_params:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                disk_size_gb: &quot;{{ disk_size_gb }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                source_image: &quot;{{ gcp_source_image }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            network_interfaces:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            - network: &quot;{{ network }}&quot;  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              ssh-keys: &quot;{{admin_user}}:{{ ssh_pub_key }}&quot; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        auth_kind: &quot;{{ gcp_cred_kind }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        project: &quot;{{ gcp_project }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        service_account_file: &quot;{{ gcp_cred_file }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        state: &quot;{{ desired_state }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      register: instancetemplate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: Create an Instance Group Manager</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      google.cloud.gcp_compute_instance_group_manager:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        name: &quot;{{gcp_instance_group_name}}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        base_instance_name: test1-child</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        instance_template: &quot;{{ instancetemplate }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        target_size: 3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        zone: &quot;{{ gcp_zone }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        auth_kind: &quot;{{ gcp_cred_kind }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        project: &quot;{{ gcp_project }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        service_account_file: &quot;{{ gcp_cred_file }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        state: &quot;{{ desired_state }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      register: igm</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      ignore_errors: true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: Get Instance Group Info</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      google.cloud.gcp_compute_instance_group_info:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        filters:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          - name = &quot;{{ gcp_instance_group_name }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        zone: &quot;{{ gcp_zone }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        auth_kind: &quot;{{ gcp_cred_kind }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        project: &quot;{{ gcp_project }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        service_account_file: &quot;{{ gcp_cred_file }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      register: iginfo</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      when: desired_state == &#x27;present&#x27;</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="application"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#application" title="Direct link to heading">#</a>Application</h2><p>The application layer in this example is a single host. </p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: Create Business Layer Host</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      google.cloud.gcp_compute_instance:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        name: bizlayer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        machine_type: f1-micro</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        disks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - auto_delete: &#x27;true&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          boot: &#x27;true&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          device_name: device1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          initialize_params:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            disk_size_gb: &quot;{{ disk_size_gb }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            source_image: &quot;{{ gcp_source_image }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        network_interfaces:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - network: &quot;{{ network }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          ssh-keys: &quot;{{admin_user}}:{{ ssh_pub_key }}&quot; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        zone: &quot;{{ gcp_zone }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        auth_kind: &quot;{{ gcp_cred_kind }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        project: &quot;{{ gcp_project }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        service_account_file: &quot;{{ gcp_cred_file }}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        state: &quot;{{ desired_state }}&quot;</span></div></div></div></div></div><p>In some environments it would likely be desireable to have a load balancer and autoscale set here to keep the business layer from becoming a bottleneck. If that&#x27;s the case you can consider creating one similarly to how we did for the frontend systems.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="load-balancer"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#load-balancer" title="Direct link to heading">#</a>Load Balancer</h2><p>As part of the certified collection from Google for Google Cloud Platform, they have provided a really nice role to configure a loadbalancer, making this a super easy setup:</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: Create a Load Balancer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      import_role:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        name: google.cloud.gcp_http_lb</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="database"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#database" title="Direct link to heading">#</a>Database</h2><p>Of all the steps in this provisioning process, the database creation takes the longest. Be patient during the creation period of these services to come online.</p><p>Once everything is complete, we&#x27;re ready to populate our database, setup the business logic server, and configure our frontend apps. </p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="config"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#config" title="Direct link to heading">#</a>Config</h1><p>TODO</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/gcp.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/tiered-website/docs/azure"><div class="pagination-nav__link--sublabel">Previous</div><div class="pagination-nav__link--label">« Azure</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="contents contents__left-border"><li><a href="#prerequisites" class="contents__link">Prerequisites</a><ul><li><a href="#a-note-about-collections" class="contents__link">A note about collections</a></li></ul></li><li><a href="#presentation" class="contents__link">Presentation</a></li><li><a href="#application" class="contents__link">Application</a></li><li><a href="#load-balancer" class="contents__link">Load Balancer</a></li><li><a href="#database" class="contents__link">Database</a></li></ul></div></div></div></div></main></div></div>
</div>

<script src="/tiered-website/styles.77a41af3.js"></script>

<script src="/tiered-website/runtime~main.88a59206.js"></script>

<script src="/tiered-website/main.b46ab0b8.js"></script>

<script src="/tiered-website/1.ec644f8d.js"></script>

<script src="/tiered-website/2.4c4c9348.js"></script>

<script src="/tiered-website/20.4f78e627.js"></script>

<script src="/tiered-website/39b4e302.6884ff92.js"></script>

<script src="/tiered-website/17896441.4c0ae586.js"></script>

<script src="/tiered-website/1800c3e5.88b1af97.js"></script>


</body>
</html>